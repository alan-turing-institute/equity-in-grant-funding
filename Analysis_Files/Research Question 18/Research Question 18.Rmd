---
title: "Bias in EPSRC Peer Review - Research Question 18"
author: 'Contributors: Ged Hiscoke & Dakota Langhals, Royal Statistical Society'
date: "Version: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    code_folding: hide
    toc_float: yes
  pdf_document: default
  word_document:
    reference_docx: "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/PROJ2023.002 - Data folder DL Pickup/Draft Outputs/r_style_template.docx"
    highlight: null
subtitle: 'Status: Final'
---

```{r setup, include=FALSE}

##Universal Document settings
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 12, warning = FALSE, message = FALSE)


## Libraries
library(boot)
library(tidyverse)
library(kableExtra)
library(scales)
library(tibble)
library(purrr)
library(nortest)
library(pscl)  # For pseudo-R^2
library(betareg)  # For beta regression
library(openxlsx)   # for saving tables as excel files
# various regression-related packages
library(performance)
library(lmtest)
library(jtools)
library(sandwich)
library(stargazer)
library(car)
library(lme4)
library(gtExtras)









## Set key file locations
## Directory for saving local high resolution copies of plots etc
data_folder_path    <- "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/PROJ2023.002 - Data folder DL Pickup/Datasets/"
figure_folder_path  <- "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18"




## Set key file names
WorkingEnvironment  <- "PROJ2023.002 Environment - WORKING.RData"


## Load needed data
load(file = file.path(data_folder_path, WorkingEnvironment))



## Define the RSS colour palette

RRSSgold      <- "#D3A41B" 
RSSblue       <- "#004B6D" 
RSSred        <- "#cc0000" 
RSStaupe      <- "#a6a086" 
RSSgreen      <- "#009933" 
RSSpurple     <- "#7879b9" 
RSSdark       <- "#393f4d" 
RSSlightblue    <- "#6db4c0" 
RSSseablue       <- "#287fc3" 
RSSorange     <- "#d86027"
RSSlightgrey  <- "#bdbdbd"
RSSmidgrey    <- "#939393"
RSSdarkkgrey  <- "#7e7e7e"
RSSjungle     <- "#1f3d0c"
RSSmint       <- "#5C9090" 
RSSherb       <- "#689E88"
RSSbright     <- "#8D31A4"
RSSlime       <- "#7DCF7A"
RSSviolet     <- "#614182"


##Variable specific colours
col_male      <- "#004b6d"
col_female    <- "#a6700a"
col_uk        <- "#393f4d"
col_nonuk     <- "#614182"
col_dis       <- "#005b49"
col_nodis     <- "#8e8e00"
col_white     <- "#7f3c21"
col_ethmin    <- "#3a3877"
col_unknown   <- "#bdbdbd"
col_notdisclosed  <- "#640106"
col_age1 <- "#b6d6b3"
col_age2 <- "#87bd00"
col_age3 <- "#299907"
col_age4 <- "#146f03"
col_age5 <- "#054907"
col_age6 <- "#0f2808"
col_eth1 <- "#a7a7c1"
col_eth2 <- "#74749d"
col_eth3 <- "#1e3399"
col_eth4 <- "#090771"
col_eth5 <- "#37163e"
col_eth6 <- "#59095f"
col_eth7 <- "#34086e"
```

# {.tabset}

## Data Preparation  {.tabset}

```{r}
## This dataframe will include Grant (rather than unique researcher)

## 1.1 Select columns from Grants.df
Grants_selected.df <- EPSRC$Grants.df %>%
  select(AnonPROJ,
         GrantCategory,
         GrantOutcome,
         AdjustedApplicationValue,
         Driver,
         AnonREG,
         FYDecisionDate
  )


## 1.2 Now select additional columns from PrincipalInvestigators.df
PI_details.df <- EPSRC$PI.df %>%
  select(
    AnonPROJ,
    AnonINV,
    Sex,
    AgeRange,
    Disability,
    EthnicGroup,
    EthnicityBinary,
    NationalityBinary,
    AnonTHM,
    Role
  )


## 1.3 Merge with PrincipalInvestigators.df
Q18Grants.df <- left_join(PI_details.df,
                 Grants_selected.df ,
                 by = "AnonPROJ"
)


## 1.4 Cleanup
rm(PI_details.df, 
   Grants_selected.df
)

## Add a binary Outcome variable for Funded/Unfunded
Q18Grants.df$BinaryOutcome <- ifelse(Q18Grants.df$GrantOutcome == "Funded", "Funded", "Unfunded")

Q18Grants.df <- Q18Grants.df %>% 
  mutate(BinaryOutcome = factor(BinaryOutcome)) %>% 
  mutate(BinaryOutcome = relevel(BinaryOutcome, ref = "Unfunded")) ## this coding ensures that the "success" category is "Funded" rather than "Unfunded"

Q18Grants.df <- Q18Grants.df %>% 
  mutate(AgeRangeCollapsed = case_when(AgeRange == "25 and Under" ~ "35 and Under", 
                                       AgeRange == "26-35" ~ "35 and Under",
                                       AgeRange == "36-45" ~ "36-55",
                                       AgeRange == "46-55" ~ "36-55",
                                       AgeRange == "56-65" ~ "56 and Over",
                                       AgeRange == "66+" ~  "56 and Over"))

Q18Grants.df$AgeRangeCollapsed <- factor(Q18Grants.df$AgeRangeCollapsed)



# Create temp.df by grouping and filtering for the max RAFraction 
temp.df <- EPSRC$ResearchAreas.df %>% 
  group_by(AnonPROJ) %>% 
  filter(RAFraction == max(RAFraction)) %>% 
  ungroup() 

# Perform a left join to merge dataframes 
Q18Grants.df <- Q18Grants.df %>% 
  left_join(temp.df %>% select(AnonPROJ, AnonRAG), by = "AnonPROJ") 

# Remove temp.df from the environment 
rm(temp.df) 

```





## Responsive Funding Opportunities, Binary Funding Success

```{r}
df <- Q18Grants.df %>% filter(Driver == "Responsive") 

## Removing unknown and not disclosed values
df <- df %>%
  filter(!Sex == "Unknown" &
           !EthnicityBinary == "Unknown" &
           !NationalityBinary == "Unknown" &
           !AgeRangeCollapsed == "Unknown" &
           !Disability == "Unknown" &
           !Sex == "Not Disclosed" &
           !EthnicityBinary == "Not Disclosed" &
           !AgeRangeCollapsed == "Not Disclosed" &
           !Disability == "Not Disclosed")


## Ensure proper reference levels
df$Sex <- relevel(df$Sex, ref = "Male")
df$EthnicityBinary <- relevel(df$EthnicityBinary, ref = "White")
df$AgeRangeCollapsed <- relevel(df$AgeRangeCollapsed, ref = "36-55")
df$NationalityBinary <- relevel(df$NationalityBinary, ref = "UK")
df$Disability <- relevel(df$Disability, ref = "No Known Disability")



# Aligning the models with what was done in the pre-registered analysis for binary funding success

model1 <- glmer(BinaryOutcome ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df,
                     family = binomial(link = "logit"))

model2 <- glmer(BinaryOutcome ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df,
                     family = binomial(link = "logit"))


lrt <- anova(model1, model2, test = "LRT")
print(lrt)

summary(model1)
```

```{r fig.height = 12, fig.width = 12}
chosen_model <- model2

check_model(chosen_model)
```

```{r rows.print = 40}
# Calculate confidence intervals:
se <- sqrt(diag(vcov(chosen_model)))

# table of estimates with 95% CI
coefficient_table <- cbind(Est = fixef(chosen_model), LL = fixef(chosen_model) - 1.96 * se, UL = fixef(chosen_model) + 1.96 *se)

# table of estimates as ORs with 95% CI
coefficient_table_exp <- exp(coefficient_table)

# Rounding to make more readable
coefficient_table_exp_rounded <- round(coefficient_table_exp, 3)

coefficient_table_exp_rounded_df <- as.data.frame(coefficient_table_exp_rounded)

coefficient_table_exp_rounded_df$Predictor <- row.names(coefficient_table_exp_rounded_df)


coefficient_table_exp_rounded_df <- coefficient_table_exp_rounded_df %>%  ## clean up the names of the predictors for better presentation
  mutate(Predictor = case_when(
    Predictor == "GrantCategoryResearch Grant" ~ "Research Grant",
    Predictor == "SexFemale" ~ "Female",
    Predictor == "SexUnknown" ~ "Sex Unknown",
    Predictor == "NationalityBinaryUnknown" ~ "Nationality Unknown",
    Predictor == "NationalityBinaryNot Disclosed" ~ "Undisclosed Nationality",
    Predictor == "NationalityBinaryNon UK" ~ "Non-UK Nationality",
    Predictor == "EthnicityBinaryEthnic Minority" ~ "Ethnic Minority",
    Predictor == "EthnicityBinaryUnknown" ~ "Ethnicity Unknown",
    Predictor == "DisabilityKnown Disability" ~ "Known Disability",
    Predictor == "DisabilityNo Known Disability" ~ "No Known Disability",
    Predictor == "AgeRangeCollapsed56 and Over" ~ "Age > 55",
    Predictor == "AgeRangeCollapsed35 and Under" ~ "Age < 36",
    Predictor == "(Intercept)" ~ "(Intercept)",
    Predictor == "SexFemale:EthnicityBinaryEthnic Minority" ~ "Ethnic Minority Female",
    Predictor == "SexFemale:AgeRangeCollapsed35 and Under" ~ "Female 35 or Younger",
    Predictor == "SexFemale:AgeRangeCollapsed56 and Over" ~ "Female 56 or Older",
    Predictor == "EthnicityBinaryEthnic Minority:AgeRangeCollapsed35 and Under" ~ "Ethnic Minority 35 or Younger",
    Predictor == "EthnicityBinaryEthnic Minority:AgeRangeCollapsed56 and Over" ~ "Ethnic Minority 56 or Older",
    TRUE ~ Predictor  # Keep original value if no match is found
  ))



library(stringr)

OR_Bin_table_for_report <- coefficient_table_exp_rounded_df %>% filter(!str_detect(Predictor, "Unknown"))
rownames(OR_Bin_table_for_report) <- NULL

OR_Bin_table_for_report <- OR_Bin_table_for_report %>% 
  select(Predictor, everything()) %>% 
  rename(Odds_Ratio = Est,
         CI_Lower_Limit = LL,
         CI_Upper_Limit = UL)


print(OR_Bin_table_for_report) ### turn this into a table for the report
```

```{r}
OR_Bin_table_for_report <- OR_Bin_table_for_report %>%
  mutate(Odds_Ratio = case_when(
      CI_Lower_Limit > 1 | CI_Upper_Limit < 1 ~ paste0(format(Odds_Ratio, nsmall = 3), "*"),
      TRUE                                    ~ format(Odds_Ratio, nsmall = 3)
    )
  )

# Saving the table as an image
gt_table <- gt(OR_Bin_table_for_report)

gt_table <- gt_table %>%
  tab_header(
    title = md("**Mixed-Effects Model of Binary Funding Success Against\nPredictors, Responsive Opportunities**"),
    subtitle = md("_Odds Ratios and 95% Confidence Intervals for Fixed-Effect Predictors_")
  ) %>%
  tab_footnote(
    footnote = md("_* = significant at 5% significance level_"),
    locations = cells_title(groups = "subtitle")
  ) %>%
  fmt_number(
    columns = c(Predictor, Odds_Ratio, CI_Lower_Limit, CI_Upper_Limit), 
    decimals = 3
  ) %>%
  cols_label(
    Predictor = "Predictor",
    Odds_Ratio = "Odds Ratio",
    CI_Lower_Limit = "CI Lower Limit",
    CI_Upper_Limit = "CI Upper Limit"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
      )
  ) %>% 
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    heading.subtitle.font.size = px(14),
    data_row.padding = px(12)
  ) %>%
  cols_align(
    align = "left",  
    columns = c(Predictor)  
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Responsive_OR_Bin_table_for_report.png")

```


### Model Predictions

```{r}
newdata_bin = Q18Grants.df %>% filter(Driver == "Responsive" & 
                                     !Sex == "Unknown" &
                                     !EthnicityBinary == "Unknown" &
                                     !NationalityBinary == "Unknown" &
                                     !AgeRangeCollapsed == "Unknown" &
                                     !Disability == "Unknown" &
                                     !Sex == "Not Disclosed" &
                                     !EthnicityBinary == "Not Disclosed" &
                                     !AgeRangeCollapsed == "Not Disclosed" &
                                     !Disability == "Not Disclosed") %>% select(Sex, EthnicityBinary, AgeRangeCollapsed, Disability, NationalityBinary, GrantCategory, AnonRAG, AnonTHM, AnonREG, FYDecisionDate)
newdata_bin <- na.omit(newdata_bin)


# Change sex and ethnicity for all observations to desired groupings (all combinations of ethnicity and sex)
newdata_binWM <- newdata_bin %>% mutate(EthnicityBinary = "White", Sex = "Male")
newdata_binWF <- newdata_bin %>% mutate(EthnicityBinary = "White", Sex = "Female")
newdata_binEM <- newdata_bin %>% mutate(EthnicityBinary = "Ethnic Minority", Sex = "Male")
newdata_binEF <- newdata_bin %>% mutate(EthnicityBinary = "Ethnic Minority", Sex = "Female")

# Get the predictions for each observation after the changes
newdata_binWM$predicted <- predict(chosen_model, newdata_binWM, type = "response")
newdata_binWF$predicted <- predict(chosen_model, newdata_binWF, type = "response")
newdata_binEM$predicted <- predict(chosen_model, newdata_binEM, type = "response")
newdata_binEF$predicted <- predict(chosen_model, newdata_binEF, type = "response")

# Calculate the mean predictions
outputs_binWM <- newdata_binWM %>% 
  group_by(Sex, EthnicityBinary) %>% 
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binWF <- newdata_binWF %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binEM <- newdata_binEM %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binEF <- newdata_binEF %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_bin_table <- rbind(outputs_binWM, outputs_binWF, outputs_binEM, outputs_binEF)

outputs_bin_table
```

```{r}
# Saving the table as an image
outputs_bin_table <- outputs_bin_table %>%
  filter(Sex != "Unknown", EthnicityBinary != "Unknown") %>%
  mutate(SexEthnicity = paste(Sex, EthnicityBinary, sep = ", ")) %>%  # Combine Sex and Ethnicity
  select(SexEthnicity, mean_pred) %>%                  # Rearrange columns
  group_by(SexEthnicity) %>%
  mutate(SexEthnicity = if_else(row_number() == 1, SexEthnicity, "")) %>%  # Blank duplicate rows
  ungroup()

outputs_bin_table <- outputs_bin_table %>% select(-c(Sex))

# Step 2: Create the gt table
gt_table <- gt(outputs_bin_table) %>%
  tab_header(
    title = md("**Average Predicted Probabilities of Funding Success for\nResponsive Funding Opportunities, Selected Demographics**"),
    subtitle = md("_Average Predictions Based on Mixed-Effects Model for Binary Funding Success_")
  ) %>%
  fmt_percent(
    columns = c(mean_pred), 
    decimals = 1
  ) %>%
  cols_label(
    SexEthnicity = "Sex and Ethnicity",
    mean_pred = "Mean Prediction"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
    )
  ) %>% 
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    heading.subtitle.font.size = px(14),
    data_row.padding = px(12)
  ) %>%
  cols_align(
    align = "left",  
    columns = c(SexEthnicity)  # Left-align Sex/Ethnicity 
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Funding_Success_Predictions_Responsive.png")

```




### Strategic Funding Opportunities, Binary Funding Success

```{r}
df <- Q18Grants.df %>% filter(Driver == "Strategic") 

## Removing unknown and not disclosed values
df <- df %>%
  filter(!Sex == "Unknown" &
           !EthnicityBinary == "Unknown" &
           !NationalityBinary == "Unknown" &
           !AgeRangeCollapsed == "Unknown" &
           !Disability == "Unknown" &
           !Sex == "Not Disclosed" &
           !EthnicityBinary == "Not Disclosed" &
           !AgeRangeCollapsed == "Not Disclosed" &
           !Disability == "Not Disclosed")


## Ensure proper reference levels
df$Sex <- relevel(df$Sex, ref = "Male")
df$EthnicityBinary <- relevel(df$EthnicityBinary, ref = "White")
df$AgeRangeCollapsed <- relevel(df$AgeRangeCollapsed, ref = "36-55")
df$NationalityBinary <- relevel(df$NationalityBinary, ref = "UK")
df$Disability <- relevel(df$Disability, ref = "No Known Disability")



# Aligning the models with what was done in the pre-registered analysis for binary funding success

model1 <- glmer(BinaryOutcome ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df,
                     family = binomial(link = "logit"))

model2 <- glmer(BinaryOutcome ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df,
                     family = binomial(link = "logit"))


lrt <- anova(model1, model2, test = "LRT")
print(lrt)

summary(model1)
```

```{r fig.height = 12, fig.width = 12}
chosen_model <- model2

check_model(chosen_model)
```

```{r rows.print = 40}
# Calculate confidence intervals:
se <- sqrt(diag(vcov(chosen_model)))

# table of estimates with 95% CI
coefficient_table <- cbind(Est = fixef(chosen_model), LL = fixef(chosen_model) - 1.96 * se, UL = fixef(chosen_model) + 1.96 *se)

# table of estimates as ORs with 95% CI
coefficient_table_exp <- exp(coefficient_table)

# Rounding to make more readable
coefficient_table_exp_rounded <- round(coefficient_table_exp, 3)

coefficient_table_exp_rounded_df <- as.data.frame(coefficient_table_exp_rounded)

coefficient_table_exp_rounded_df$Predictor <- row.names(coefficient_table_exp_rounded_df)


coefficient_table_exp_rounded_df <- coefficient_table_exp_rounded_df %>%  ## clean up the names of the predictors for better presentation
  mutate(Predictor = case_when(
    Predictor == "GrantCategoryResearch Grant" ~ "Research Grant",
    Predictor == "SexFemale" ~ "Female",
    Predictor == "SexUnknown" ~ "Sex Unknown",
    Predictor == "NationalityBinaryUnknown" ~ "Nationality Unknown",
    Predictor == "NationalityBinaryNot Disclosed" ~ "Undisclosed Nationality",
    Predictor == "NationalityBinaryNon UK" ~ "Non-UK Nationality",
    Predictor == "EthnicityBinaryEthnic Minority" ~ "Ethnic Minority",
    Predictor == "EthnicityBinaryUnknown" ~ "Ethnicity Unknown",
    Predictor == "DisabilityKnown Disability" ~ "Known Disability",
    Predictor == "DisabilityNo Known Disability" ~ "No Known Disability",
    Predictor == "AgeRangeCollapsed56 and Over" ~ "Age > 55",
    Predictor == "AgeRangeCollapsed35 and Under" ~ "Age < 36",
    Predictor == "(Intercept)" ~ "(Intercept)",
    Predictor == "SexFemale:EthnicityBinaryEthnic Minority" ~ "Ethnic Minority Female",
    Predictor == "SexFemale:AgeRangeCollapsed35 and Under" ~ "Female 35 or Younger",
    Predictor == "SexFemale:AgeRangeCollapsed56 and Over" ~ "Female 56 or Older",
    Predictor == "EthnicityBinaryEthnic Minority:AgeRangeCollapsed35 and Under" ~ "Ethnic Minority 35 or Younger",
    Predictor == "EthnicityBinaryEthnic Minority:AgeRangeCollapsed56 and Over" ~ "Ethnic Minority 56 or Older",
    TRUE ~ Predictor  # Keep original value if no match is found
  ))


library(stringr)

OR_Bin_table_for_report <- coefficient_table_exp_rounded_df %>% filter(!str_detect(Predictor, "Unknown"))
rownames(OR_Bin_table_for_report) <- NULL

OR_Bin_table_for_report <- OR_Bin_table_for_report %>% 
  select(Predictor, everything()) %>% 
  rename(Odds_Ratio = Est,
         CI_Lower_Limit = LL,
         CI_Upper_Limit = UL)


print(OR_Bin_table_for_report) ### turn this into a table for the report
```

```{r}
OR_Bin_table_for_report <- OR_Bin_table_for_report %>%
  mutate(Odds_Ratio = case_when(
      CI_Lower_Limit > 1 | CI_Upper_Limit < 1 ~ paste0(format(Odds_Ratio, nsmall = 3), "*"),
      TRUE                                    ~ format(Odds_Ratio, nsmall = 3)
    )
  )

# Saving the table as an image
gt_table <- gt(OR_Bin_table_for_report)

gt_table <- gt_table %>%
  tab_header(
    title = md("**Mixed-Effects Model of Binary Funding Success Against\nPredictors, Strategic Opportunities**"),
    subtitle = md("_Odds Ratios and 95% Confidence Intervals for Fixed-Effect Predictors_")
  ) %>%
  tab_footnote(
    footnote = md("_* = significant at 5% significance level_"),
    locations = cells_title(groups = "subtitle")
  ) %>%
  fmt_number(
    columns = c(Predictor, Odds_Ratio, CI_Lower_Limit, CI_Upper_Limit), 
    decimals = 3
  ) %>%
  cols_label(
    Predictor = "Predictor",
    Odds_Ratio = "Odds Ratio",
    CI_Lower_Limit = "CI Lower Limit",
    CI_Upper_Limit = "CI Upper Limit"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
      )
  ) %>% 
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    heading.subtitle.font.size = px(14),
    data_row.padding = px(12)
  ) %>%
  cols_align(
    align = "left",  
    columns = c(Predictor)  
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Strategic_OR_Bin_table_for_report.png")

```

### Model Predictions

```{r}
newdata_bin = Q18Grants.df %>% filter(Driver == "Strategic" & 
                                     !Sex == "Unknown" &
                                     !EthnicityBinary == "Unknown" &
                                     !NationalityBinary == "Unknown" &
                                     !AgeRangeCollapsed == "Unknown" &
                                     !Disability == "Unknown" &
                                     !Sex == "Not Disclosed" &
                                     !EthnicityBinary == "Not Disclosed" &
                                     !AgeRangeCollapsed == "Not Disclosed" &
                                     !Disability == "Not Disclosed") %>% select(Sex, EthnicityBinary, AgeRangeCollapsed, Disability, NationalityBinary, GrantCategory, AnonRAG, AnonTHM, AnonREG, FYDecisionDate)
newdata_bin <- na.omit(newdata_bin)


# Change sex and ethnicity for all observations to desired groupings (all combinations of ethnicity and sex)
newdata_binWM <- newdata_bin %>% mutate(EthnicityBinary = "White", Sex = "Male")
newdata_binWF <- newdata_bin %>% mutate(EthnicityBinary = "White", Sex = "Female")
newdata_binEM <- newdata_bin %>% mutate(EthnicityBinary = "Ethnic Minority", Sex = "Male")
newdata_binEF <- newdata_bin %>% mutate(EthnicityBinary = "Ethnic Minority", Sex = "Female")

# Get the predictions for each observation after the changes
newdata_binWM$predicted <- predict(chosen_model, newdata_binWM, type = "response")
newdata_binWF$predicted <- predict(chosen_model, newdata_binWF, type = "response")
newdata_binEM$predicted <- predict(chosen_model, newdata_binEM, type = "response")
newdata_binEF$predicted <- predict(chosen_model, newdata_binEF, type = "response")

# Calculate the mean predictions
outputs_binWM <- newdata_binWM %>% 
  group_by(Sex, EthnicityBinary) %>% 
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binWF <- newdata_binWF %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binEM <- newdata_binEM %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_binEF <- newdata_binEF %>% 
  group_by(Sex, EthnicityBinary) %>%
  summarise(
    mean_pred = mean(predicted, na.rm = TRUE)
  )

outputs_bin_table <- rbind(outputs_binWM, outputs_binWF, outputs_binEM, outputs_binEF)

outputs_bin_table
```

```{r}
# Saving the table as an image
outputs_bin_table <- outputs_bin_table %>%
  filter(Sex != "Unknown", EthnicityBinary != "Unknown") %>%
  mutate(SexEthnicity = paste(Sex, EthnicityBinary, sep = ", ")) %>%  # Combine Sex and Ethnicity
  select(SexEthnicity, mean_pred) %>%                  # Rearrange columns
  group_by(SexEthnicity) %>%
  mutate(SexEthnicity = if_else(row_number() == 1, SexEthnicity, "")) %>%  # Blank duplicate rows
  ungroup()

outputs_bin_table <- outputs_bin_table %>% select(-c(Sex))

# Step 2: Create the gt table
gt_table <- gt(outputs_bin_table) %>%
  tab_header(
    title = md("**Average Predicted Probabilities of Funding Success for\nStrategic Funding Opportunities, Selected Demographics**"),
    subtitle = md("_Average Predictions Based on Mixed-Effects Model for Binary Funding Success_")
  ) %>%
  fmt_percent(
    columns = c(mean_pred), 
    decimals = 1
  ) %>%
  cols_label(
    SexEthnicity = "Sex and Ethnicity",
    mean_pred = "Mean Prediction"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
    )
  ) %>% 
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    heading.subtitle.font.size = px(14),
    data_row.padding = px(12)
  ) %>%
  cols_align(
    align = "left",  
    columns = c(SexEthnicity)  # Left-align Sex/Ethnicity 
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Funding_Success_Predictions_Strategic.png")

```






## Award Value Regression Models

### Responsive Funding Opportunities

```{r}
df <- Q18Grants.df %>% filter(Driver == "Responsive", BinaryOutcome == "Funded", AdjustedApplicationValue > 0) 

## Removing unknown and not disclosed values
df <- df %>%
  filter(!Sex == "Unknown" &
           !EthnicityBinary == "Unknown" &
           !NationalityBinary == "Unknown" &
           !AgeRangeCollapsed == "Unknown" &
           !Disability == "Unknown" &
           !Sex == "Not Disclosed" &
           !EthnicityBinary == "Not Disclosed" &
           !AgeRangeCollapsed == "Not Disclosed" &
           !Disability == "Not Disclosed")



## Ensure proper reference levels
df$Sex <- relevel(df$Sex, ref = "Male")
df$EthnicityBinary <- relevel(df$EthnicityBinary, ref = "White")
df$AgeRangeCollapsed <- relevel(df$AgeRangeCollapsed, ref = "36-55")
df$NationalityBinary <- relevel(df$NationalityBinary, ref = "UK")
df$Disability <- relevel(df$Disability, ref = "No Known Disability")

```


```{r}
# Aligning the models for award value with what was done in the pre-registered analysis for binary funding success and TopQuartile panel ranking.

model1 <- lmer(AdjustedApplicationValue ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model2 <- lmer(log(AdjustedApplicationValue) ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + 
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model3 <- lmer(AdjustedApplicationValue ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model4 <- lmer(log(AdjustedApplicationValue) ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)


# Create a dataframe to compare models
model_comparison <- data.frame(
  Model = c(
    "Linear Model",
    "Linear Model Log - Transformed",
    "Linear Model w/ interactions",
    "Linear Model w/ interactions Log - Transformed"
  ),
  
  AIC = c(
    AIC(model1),
    AIC(model2),
    AIC(model3),
    AIC(model4)
  ),
  
  BIC = c(
    BIC(model1),
    BIC(model2),
    BIC(model3),
    BIC(model4) 
  )

)

table4.19 <- model_comparison

table4.19

lrtest(model1, model3)
lrtest(model2, model4)

```

```{r fig.height = 12, fig.width = 12}
chosen_model <- model2

plot(chosen_model)
check_model(chosen_model)  
```

Base output from model
```{r}
summary(chosen_model)
```

Exponentiating coefficients and CIs because chosen model has a log-transformed dependent variable - these coefficients should be multiplicative effects, not additive
```{r}
# Calculate confidence intervals:
se <- sqrt(diag(vcov(chosen_model)))

# table of estimates with 95% CI
coefficient_table <- cbind(Est = fixef(chosen_model), LL = fixef(chosen_model) - 1.96 * se, UL = fixef(chosen_model) + 1.96 *se)

# exponentiating for interpretability - should be read multiplicatively, not additively after this
coefficient_table_exp <- exp(coefficient_table)

# Rounding to make more readable
coefficient_table_exp_rounded <- round(coefficient_table_exp, 3)

coefficient_table_exp_rounded_df <- as.data.frame(coefficient_table_exp_rounded)

print(coefficient_table_exp_rounded_df)
```


```{r}
coefficient_table_exp_rounded_df$Predictor <- row.names(coefficient_table_exp_rounded_df)


coefficient_table_exp_rounded_df <- coefficient_table_exp_rounded_df %>%  ## clean up the names of the predictors for better presentation
  mutate(Predictor = case_when(
    Predictor == "DriverStrategic" ~ "Strategic Funding Opportunity",
    Predictor == "GrantCategoryResearch Grant" ~ "Research Grant",
    Predictor == "SexFemale" ~ "Female",
    Predictor == "SexUnknown" ~ "Sex Unknown",
    Predictor == "NationalityBinaryUnknown" ~ "Nationality Unknown",
    Predictor == "NationalityBinaryNon UK" ~ "Non-UK Nationality",
    Predictor == "NationalityBinaryNot Disclosed" ~ "Undisclosed Nationality",
    Predictor == "EthnicityBinaryEthnic Minority" ~ "Ethnic Minority",
    Predictor == "EthnicityBinaryUnknown" ~ "Ethnicity Unknown",
    Predictor == "DisabilityKnown Disability" ~ "Known Disability",
    Predictor == "DisabilityNo Known Disability" ~ "No Known Disability",
    Predictor == "AgeRangeCollapsed56 and Over" ~ "Age > 55",
    Predictor == "AgeRangeCollapsed35 and Under" ~ "Age < 36",
    Predictor == "(Intercept)" ~ "(Intercept)",
    TRUE ~ Predictor  # Keep original value if no match is found
  ))

library(stringr)

Value_table_for_report <- coefficient_table_exp_rounded_df %>% filter(!str_detect(Predictor, "Unknown"))
rownames(Value_table_for_report) <- NULL

Value_table_for_report <- Value_table_for_report %>% 
  select(Predictor, everything()) %>% 
  rename(Effect = Est,
         CI_Lower_Limit = LL,
         CI_Upper_Limit = UL)


print(Value_table_for_report) ### turn this into a table for the report
```

```{r}
Value_table_for_report <- Value_table_for_report %>%
  mutate(Effect = case_when(
      CI_Lower_Limit > 1 | CI_Upper_Limit < 1 ~ paste0(format(Effect, nsmall = 3), "*"),
      TRUE                                    ~ format(Effect, nsmall = 3)
    )
  )

# Saving the table as an image
gt_table <- gt(Value_table_for_report)

gt_table <- gt_table %>%
  tab_header(
    title = md("**Mixed-Effects Model of Award Value Against\nPredictors, Responsive Opportunities**"),
    subtitle = md("_Exponentiated Coefficients and 95% CI (Application Level)_")
  ) %>%
  tab_footnote(
    footnote = md("_* = significant at 5% significance level_"),
    locations = cells_title(groups = "subtitle")
  ) %>%
  fmt_number(
    columns = c(Effect, CI_Lower_Limit, CI_Upper_Limit), 
    decimals = 3
  ) %>%
  cols_label(
    Predictor = "Predictor",
    Effect = "Effect (multiplicative)",
    CI_Lower_Limit = "CI Lower Limit",
    CI_Upper_Limit = "CI Upper Limit"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
      )
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Responsive_Value_table_for_report.png")

```





### Strategic Funding Opportunities

```{r}
df <- Q18Grants.df %>% filter(Driver == "Strategic", BinaryOutcome == "Funded", AdjustedApplicationValue > 0) 

## Removing unknown and not disclosed values
df <- df %>%
  filter(!Sex == "Unknown" &
           !EthnicityBinary == "Unknown" &
           !NationalityBinary == "Unknown" &
           !AgeRangeCollapsed == "Unknown" &
           !Disability == "Unknown" &
           !Sex == "Not Disclosed" &
           !EthnicityBinary == "Not Disclosed" &
           !AgeRangeCollapsed == "Not Disclosed" &
           !Disability == "Not Disclosed")



## Ensure proper reference levels
df$Sex <- relevel(df$Sex, ref = "Male")
df$EthnicityBinary <- relevel(df$EthnicityBinary, ref = "White")
df$AgeRangeCollapsed <- relevel(df$AgeRangeCollapsed, ref = "36-55")
df$NationalityBinary <- relevel(df$NationalityBinary, ref = "UK")
df$Disability <- relevel(df$Disability, ref = "No Known Disability")

```


```{r}
# Aligning the models for award value with what was done in the pre-registered analysis for binary funding success and TopQuartile panel ranking.

model1 <- lmer(AdjustedApplicationValue ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model2 <- lmer(log(AdjustedApplicationValue) ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + 
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model3 <- lmer(AdjustedApplicationValue ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)

model4 <- lmer(log(AdjustedApplicationValue) ~ Sex + EthnicityBinary + AgeRangeCollapsed + NationalityBinary + Disability + GrantCategory + Sex:EthnicityBinary + Sex:AgeRangeCollapsed + EthnicityBinary:AgeRangeCollapsed +
                       (1 | AnonRAG) +
                       (1 | AnonREG) +
                       (1 | AnonTHM) +
                       (1 | FYDecisionDate),
                     data = df)


# Create a dataframe to compare models
model_comparison <- data.frame(
  Model = c(
    "Linear Model",
    "Linear Model Log - Transformed",
    "Linear Model w/ interactions",
    "Linear Model w/ interactions Log - Transformed"
  ),
  
  AIC = c(
    AIC(model1),
    AIC(model2),
    AIC(model3),
    AIC(model4)
  ),
  
  BIC = c(
    BIC(model1),
    BIC(model2),
    BIC(model3),
    BIC(model4) 
  )

)

table4.19 <- model_comparison

table4.19

lrtest(model1, model3)
lrtest(model2, model4)

```

```{r fig.height = 12, fig.width = 12}
chosen_model <- model2

plot(chosen_model)
check_model(chosen_model)  
```

Base output from model
```{r}
summary(chosen_model)
```

Exponentiating coefficients and CIs because chosen model has a log-transformed dependent variable - these coefficients should be multiplicative effects, not additive
```{r}
# Calculate confidence intervals:
se <- sqrt(diag(vcov(chosen_model)))

# table of estimates with 95% CI
coefficient_table <- cbind(Est = fixef(chosen_model), LL = fixef(chosen_model) - 1.96 * se, UL = fixef(chosen_model) + 1.96 *se)

# exponentiating for interpretability - should be read multiplicatively, not additively after this
coefficient_table_exp <- exp(coefficient_table)

# Rounding to make more readable
coefficient_table_exp_rounded <- round(coefficient_table_exp, 3)

coefficient_table_exp_rounded_df <- as.data.frame(coefficient_table_exp_rounded)

print(coefficient_table_exp_rounded_df)
```


```{r}
coefficient_table_exp_rounded_df$Predictor <- row.names(coefficient_table_exp_rounded_df)


coefficient_table_exp_rounded_df <- coefficient_table_exp_rounded_df %>%  ## clean up the names of the predictors for better presentation
  mutate(Predictor = case_when(
    Predictor == "DriverStrategic" ~ "Strategic Funding Opportunity",
    Predictor == "GrantCategoryResearch Grant" ~ "Research Grant",
    Predictor == "SexFemale" ~ "Female",
    Predictor == "SexUnknown" ~ "Sex Unknown",
    Predictor == "NationalityBinaryUnknown" ~ "Nationality Unknown",
    Predictor == "NationalityBinaryNon UK" ~ "Non-UK Nationality",
    Predictor == "NationalityBinaryNot Disclosed" ~ "Undisclosed Nationality",
    Predictor == "EthnicityBinaryEthnic Minority" ~ "Ethnic Minority",
    Predictor == "EthnicityBinaryUnknown" ~ "Ethnicity Unknown",
    Predictor == "DisabilityKnown Disability" ~ "Known Disability",
    Predictor == "DisabilityNo Known Disability" ~ "No Known Disability",
    Predictor == "AgeRangeCollapsed56 and Over" ~ "Age > 55",
    Predictor == "AgeRangeCollapsed35 and Under" ~ "Age < 36",
    Predictor == "(Intercept)" ~ "(Intercept)",
    TRUE ~ Predictor  # Keep original value if no match is found
  ))

library(stringr)

Value_table_for_report <- coefficient_table_exp_rounded_df %>% filter(!str_detect(Predictor, "Unknown"))
rownames(Value_table_for_report) <- NULL

Value_table_for_report <- Value_table_for_report %>% 
  select(Predictor, everything()) %>% 
  rename(Effect = Est,
         CI_Lower_Limit = LL,
         CI_Upper_Limit = UL)


print(Value_table_for_report) ### turn this into a table for the report
```

```{r}
Value_table_for_report <- Value_table_for_report %>%
  mutate(Effect = case_when(
      CI_Lower_Limit > 1 | CI_Upper_Limit < 1 ~ paste0(format(Effect, nsmall = 3), "*"),
      TRUE                                    ~ format(Effect, nsmall = 3)
    )
  )

# Saving the table as an image
gt_table <- gt(Value_table_for_report)

gt_table <- gt_table %>%
  tab_header(
    title = md("**Mixed-Effects Model of Award Value Against\nPredictors, Strategic Opportunities**"),
    subtitle = md("_Exponentiated Coefficients and 95% CI (Application Level)_")
  ) %>%
  tab_footnote(
    footnote = md("_* = significant at 5% significance level_"),
    locations = cells_title(groups = "subtitle")
  ) %>%
  fmt_number(
    columns = c(Effect, CI_Lower_Limit, CI_Upper_Limit), 
    decimals = 3
  ) %>%
  cols_label(
    Predictor = "Predictor",
    Effect = "Effect (multiplicative)",
    CI_Lower_Limit = "CI Lower Limit",
    CI_Upper_Limit = "CI Upper Limit"
  ) %>% 
  opt_table_font(
    font = list(
      "Frutiger LT Std 47 Condensed Light"
      )
  )


gtsave(data = gt_table, filename = "C:/Users/DakotaLanghals/OneDrive - Royal Statistical Society/EPSRC Grant Funding/Figures/Research Question 18/Strategic_Value_table_for_report.png")

```